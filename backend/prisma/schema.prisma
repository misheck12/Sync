generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  BURSAR
  TEACHER
  SECRETARY
  PARENT
  STUDENT
}

enum Gender {
  MALE
  FEMALE
}

enum StudentStatus {
  ACTIVE
  TRANSFERRED
  GRADUATED
  DROPPED_OUT
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_DEPOSIT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum AssessmentType {
  EXAM
  TEST
  QUIZ
  HOMEWORK
  PROJECT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum TopicStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ==========================================
// MULTI-TENANT ENUMS
// ==========================================



enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
}

enum PlatformRole {
  PLATFORM_SUPERADMIN
  PLATFORM_SUPPORT
  PLATFORM_SALES
}

// ==========================================
// TENANT (SCHOOL) - Core Multi-Tenant Model
// ==========================================

model Tenant {
  id              String   @id @default(uuid())
  name            String   // "Lusaka Academy"
  slug            String   @unique // "lusaka-academy" (for subdomain)
  domain          String?  @unique // custom domain support
  
  // Branding
  logoUrl         String?
  primaryColor    String   @default("#2563eb")
  secondaryColor  String   @default("#475569")
  accentColor     String   @default("#f59e0b")
  
  // Contact Info
  email           String
  phone           String?
  address         String?
  city            String?
  country         String   @default("ZM")
  website         String?
  
  // Subscription & Billing
  tier            String @default("FREE")
  status          SubscriptionStatus @default(TRIAL)
  trialEndsAt     DateTime?
  subscriptionStartedAt DateTime?
  subscriptionEndsAt    DateTime?
  
  // Feature Limits (based on tier, can be overridden)
  maxStudents     Int      @default(50)
  maxTeachers     Int      @default(5)
  maxUsers        Int      @default(10)
  maxClasses      Int      @default(5)
  maxStorageGB    Int      @default(1)
  
  // Feature Flags (what's enabled for this tenant)
  smsEnabled              Boolean @default(false)
  emailEnabled            Boolean @default(true)
  onlineAssessmentsEnabled Boolean @default(false)
  parentPortalEnabled     Boolean @default(false)
  reportCardsEnabled      Boolean @default(true)
  attendanceEnabled       Boolean @default(true)
  feeManagementEnabled    Boolean @default(true)
  chatEnabled             Boolean @default(false)
  advancedReportsEnabled  Boolean @default(false)
  apiAccessEnabled        Boolean @default(false)
  timetableEnabled        Boolean @default(true)
  syllabusEnabled         Boolean @default(false)
  
  // SMTP Settings (per-tenant email configuration)
  emailProvider   String?  @default("smtp") // "smtp", "ses", "sendgrid"
  smtpHost        String?
  smtpPort        Int?
  smtpSecure      Boolean  @default(true)
  smtpUser        String?
  smtpPassword    String?
  smtpFromEmail   String?
  smtpFromName    String?
  
  // SMS Settings (per-tenant)
  smsProvider     String?  // 'TWILIO', 'AFRICASTALKING'
  smsApiKey       String?
  smsApiSecret    String?
  smsSenderId     String?
  
  // Usage Tracking
  currentStudentCount  Int @default(0)
  currentTeacherCount  Int @default(0)
  currentUserCount     Int @default(0)
  currentStorageUsedMB Int @default(0)
  
  // Current Term Reference
  currentTermId   String?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations to all tenant-scoped entities
  users           User[]
  students        Student[]
  classes         Class[]
  subjects        Subject[]
  academicTerms   AcademicTerm[]
  feeTemplates    FeeTemplate[]
  payments        Payment[]
  attendance      Attendance[]
  assessments     Assessment[]
  gradingScales   GradingScale[]
  scholarships    Scholarship[]
  timetablePeriods TimetablePeriod[]
  topics          Topic[]
  lessonPlans     LessonPlan[]
  notifications   Notification[]
  conversations   Conversation[]
  subscriptionPayments SubscriptionPayment[]
  notificationTemplates NotificationTemplate[]
  auditLogs       AuditLog[]
  usageMetrics    UsageMetric[]
  
  // Security & Compliance Relations
  securityEvents  SecurityEvent[]
  accountLocks    AccountLock[]
  dataExportRequests DataExportRequest[]
  dataDeletionRequests DataDeletionRequest[]
  dataRetentionPolicies DataRetentionPolicy[]
  
  // Invoice & Reconciliation Relations
  invoices          Invoice[]
  paymentReconciliations PaymentReconciliation[]
  missingPaymentAlerts MissingPaymentAlert[]
  
  // LMS Relations
  forums            Forum[]
  announcements     Announcement[]
  
  // LMS - Forums & Announcements
  forums            Forum[]
  announcements     Announcement[]
  
  @@index([slug])
  @@index([status])
  @@map("tenants")
}

// ==========================================
// PLATFORM USER (Super Admin for all schools)
// ==========================================

model PlatformUser {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  fullName      String
  role          PlatformRole @default(PLATFORM_SUPPORT)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // CRM Relations
  assignedLeads Lead[]    @relation("AssignedLeads")
  ownedDeals    Deal[]    @relation("OwnedDeals")
  activities    Activity[] @relation("PerformedActivities")
  assignedTasks Task[]    @relation("AssignedTasks")
  createdTasks  Task[]    @relation("CreatedTasks")
  
  // Enhanced CRM Relations
  sentEmails      Email[]
  createdTemplates EmailTemplate[]
  uploadedDocuments Document[]
  assignedReminders FollowUpReminder[]
  createdQuotes   Quote[]
  generatedReports CrmReport[]
  
  @@map("platform_users")
}

// ==========================================
// PLATFORM SETTINGS (Centralized Config)
// ==========================================

model PlatformSettings {
  id              String   @id @default("default")
  
  // SMS Gateway Configuration (centralized)
  smsProvider     String   @default("zamtel") // "zamtel", "mtn", "airtel", "twilio", "africastalking"
  smsApiUrl       String?  // API endpoint
  smsApiKey       String?  // API key
  smsApiSecret    String?  // API secret/password
  smsDefaultSenderId String? @default("SYNC") // Default sender ID if tenant doesn't have one
  smsBalanceUnits Int      @default(0) // SMS credits balance
  smsCostPerUnit  Decimal  @db.Decimal(10, 4) @default(0.15) // Cost per SMS in ZMW
  
  // Email Gateway Configuration (centralized)
  emailProvider   String   @default("smtp") // "smtp", "azure", "sendgrid", "ses"
  emailApiKey     String?
  emailFromAddress String?
  emailFromName   String?  @default("Sync School Management")
  
  // Azure Communication Services Email Configuration
  azureEmailEnabled Boolean @default(false)
  azureEmailConnectionString String?
  azureEmailFromAddress String?
  azureEmailEndpoint String?
  azureEmailAccessKey String?
  
  // Platform Branding
  platformName    String   @default("Sync School Management")
  platformLogoUrl String?
  supportEmail    String?
  supportPhone    String?
  
  // Feature Toggles
  allowTenantCustomSms Boolean @default(false) // Allow tenants to use their own SMS credentials
  allowTenantCustomEmail Boolean @default(false)
  
  // Dynamic Configuration (Manage from Ops Dashboard)
  availableFeatures Json @default("[]") // [{key: 'api_access', label: 'API Access'}, ...]
  availableTiers    Json @default("[]") // [{key: 'PREMIUM', label: 'Premium', sortOrder: 5}, ...]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("platform_settings")
}

// ==========================================
// CRM ENUMS
// ==========================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  COLD_CALL
  SOCIAL_MEDIA
  TRADE_SHOW
  EMAIL_CAMPAIGN
  PARTNER
  OTHER
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  DEMO
  FOLLOW_UP
  PROPOSAL_SENT
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==========================================
// CRM MODELS
// ==========================================

// Lead - Potential school/customer before becoming a tenant
model Lead {
  id              String   @id @default(uuid())
  
  // School/Organization Info
  schoolName      String
  schoolType      String?  // Primary, Secondary, International, etc.
  website         String?
  
  // Contact Person
  contactName     String
  contactEmail    String
  contactPhone    String?
  contactRole     String?  // Principal, Admin, IT Manager, etc.
  
  // Location
  city            String?
  province        String?
  country         String   @default("Zambia")
  address         String?
  
  // Lead Info
  status          LeadStatus @default(NEW)
  source          LeadSource @default(WEBSITE)
  estimatedStudents Int?     // Estimated student count
  estimatedValue  Decimal?   @db.Decimal(12, 2) // Potential deal value
  interestedTier  String?
  
  // Assignment
  assignedToId    String?
  assignedTo      PlatformUser? @relation("AssignedLeads", fields: [assignedToId], references: [id])
  
  // Tracking
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  notes           String?   @db.Text
  
  // Conversion
  convertedToTenantId String? @unique
  convertedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  activities      Activity[]
  tasks           Task[]
  deals           Deal[]
  
  // Enhanced CRM Relations
  emails          Email[]
  documents       Document[]
  reminders       FollowUpReminder[]
  score           LeadScore?
  quotes          Quote[]
  
  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@map("crm_leads")
}

// Deal - Sales opportunity with a lead
model Deal {
  id              String   @id @default(uuid())
  
  // Deal Info
  name            String   // e.g., "Lusaka Academy - Professional Plan"
  value           Decimal  @db.Decimal(12, 2)
  currency        String   @default("ZMW")
  
  // Pipeline Stage
  stage           String   @default("prospecting") // prospecting, qualification, proposal, negotiation, closed_won, closed_lost
  probability     Int      @default(10) // 0-100%
  
  // Related
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  // Plan Info
  proposedTier    String
  proposedBillingCycle String @default("ANNUAL") // MONTHLY, ANNUAL
  
  // Dates
  expectedCloseDate DateTime?
  actualCloseDate DateTime?
  
  // Assignment
  ownerId         String?
  owner           PlatformUser? @relation("OwnedDeals", fields: [ownerId], references: [id])
  
  // Outcome
  wonReason       String?
  lostReason      String?
  competitorName  String?
  
  notes           String?   @db.Text
  
  // Enhanced CRM Relations
  documents       Document[]
  quotes          Quote[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([stage])
  @@index([ownerId])
  @@index([leadId])
  @@map("crm_deals")
}

// Activity - Calls, emails, meetings tracked for leads
model Activity {
  id              String   @id @default(uuid())
  
  type            ActivityType
  subject         String
  description     String?  @db.Text
  
  // Related
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  // Performed by
  performedById   String
  performedBy     PlatformUser @relation("PerformedActivities", fields: [performedById], references: [id])
  
  // Timing
  activityDate    DateTime @default(now())
  durationMinutes Int?
  
  // For calls
  callOutcome     String?  // connected, voicemail, no_answer, busy
  
  // For meetings
  meetingLocation String?
  attendees       String?  // Comma-separated names
  
  createdAt       DateTime @default(now())
  
  @@index([leadId])
  @@index([type])
  @@index([activityDate])
  @@map("crm_activities")
}

// Task - Follow-ups and to-dos for sales team
model Task {
  id              String   @id @default(uuid())
  
  title           String
  description     String?  @db.Text
  
  priority        TaskPriority @default(MEDIUM)
  status          TaskStatus @default(PENDING)
  
  dueDate         DateTime?
  completedAt     DateTime?
  
  // Related
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id])
  
  // Assignment
  assignedToId    String
  assignedTo      PlatformUser @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  createdById     String
  createdBy       PlatformUser @relation("CreatedTasks", fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([assignedToId])
  @@index([dueDate])
  @@map("crm_tasks")
}

// ==========================================
// SUBSCRIPTION PLANS
// ==========================================

//// Replaced Enum with Table for dynamic management
model SubscriptionTier {
  id        String   @id @default(uuid())
  name      String   // Display Name: "Professional"
  value     String   @unique // Code Value: "PROFESSIONAL"
  sortOrder Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscription_tiers")
}

model SubscriptionPlan {
  id              String   @id @default(uuid())
  name            String   // "Starter", "Professional"
  tier            String   @unique // Changed from Enum SubscriptionTier to String to allow dynamic tiers "GOLD" etc.
  description     String?
  
  // Pricing (ZMW is anchor currency)
  monthlyPriceZMW Decimal  @db.Decimal(10, 2)  // Base monthly price in ZMW
  yearlyPriceZMW  Decimal  @db.Decimal(10, 2)  // Yearly price in ZMW (discounted)
  monthlyPriceUSD Decimal  @db.Decimal(10, 2)  // USD equivalent
  yearlyPriceUSD  Decimal  @db.Decimal(10, 2)  // USD equivalent yearly
  
  // Per-student overage pricing
  pricePerStudentZMW Decimal @db.Decimal(10, 2) @default(20) // K20/student
  pricePerStudentUSD Decimal @db.Decimal(10, 2) @default(0.74) // ~$0.74/student
  
  // Included limits (students above this incur per-student charges)
  includedStudents Int      // Students included in base price
  maxStudents      Int      // Hard cap (0 = unlimited)
  maxTeachers      Int
  maxUsers         Int
  maxClasses       Int
  maxStorageGB     Int
  
  // SMS/Email/API limits per month
  includedSmsPerMonth    Int @default(0)
  includedEmailsPerMonth Int @default(100)
  monthlyApiCallLimit    Int @default(0) // 0 = Included in 'api_access' feature check (or no access), but typically we want a limit. 
                                         // Let's treat 0 as "No API Access" and -1 as "Unlimited"? 
                                         // Or stick to 0 = Unlimited like others?
                                         // Be consistent: 0 = Unlimited. 
                                         // But for "No Access", we use the 'features' array (missing 'api_access').

  
  // Features included (JSON array of feature keys)
  features        String[] // ["sms", "parent_portal", "api_access", "online_assessments"]
  
  isActive        Boolean  @default(true)
  isPopular       Boolean  @default(false)
  sortOrder       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  subscriptionPayments SubscriptionPayment[]
  
  @@map("subscription_plans")
}

// ==========================================
// SUBSCRIPTION PAYMENTS
// ==========================================

model SubscriptionPayment {
  id              String   @id @default(uuid())
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  planId          String
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  
  // Payment details
  baseAmount      Decimal  @db.Decimal(10, 2)  // Base plan price
  studentCount    Int      // Number of students at time of payment
  overageStudents Int      @default(0)         // Students above included limit
  overageAmount   Decimal  @db.Decimal(10, 2) @default(0) // Extra student charges
  totalAmount     Decimal  @db.Decimal(10, 2)  // Final amount charged
  currency        String   @default("ZMW")
  
  // Payment method & reference
  paymentMethod   String   // "mtn_momo", "airtel_money", "bank_transfer", "card"
  externalRef     String?  // Payment gateway reference
  receiptNumber   String?  @unique
  
  // Billing period
  billingCycle    BillingCycle @default(MONTHLY)
  periodStart     DateTime
  periodEnd       DateTime
  
  // Status
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  failureReason   String?
  
  // Metadata
  invoiceUrl      String?
  notes           String?
  
  // Invoice relation
  invoice         Invoice?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([status])
  @@map("subscription_payments")
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ==========================================
// CONTACT FORM SUBMISSIONS (from website)
// ==========================================

model ContactSubmission {
  id          String   @id @default(uuid())
  name        String
  email       String
  phone       String?
  schoolName  String?
  message     String
  isRead      Boolean  @default(false)
  notes       String?  // Internal notes from sales team
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("contact_submissions")
}

model User {
  id            String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email         String   
  passwordHash  String
  fullName      String
  role          Role
  profilePictureUrl String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  classesManaged Class[]
  paymentsRecorded Payment[] @relation("RecordedPayments")
  voidedPayments   Payment[] @relation("VoidedPayments")
  attendanceRecorded Attendance[]
  classMovementsRecorded ClassMovementLog[]
  children Student[] @relation("ParentChildren")
  assessmentsGraded AssessmentResult[]
  studentProfile Student?
  timetablePeriodsTaught TimetablePeriod[]
  lessonPlans    LessonPlan[]
  notifications  Notification[]
  
  // Chat Relations
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]
  pushSubscriptions        PushSubscription[]
  
  // Audit logs created by this user
  auditLogs                AuditLog[]
  
  // Security
  twoFactorAuth            TwoFactorAuth?
  
  // LMS Relations
  forumsCreated            Forum[]
  forumTopicsCreated       ForumTopic[]
  forumPosts               ForumPost[]
  forumPostLikes           ForumPostLike[]
  announcementsCreated     Announcement[]
  announcementReads        AnnouncementRead[]

  // Email is unique within a tenant (same email can exist in different schools)
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, role])  // For filtering users by role
  @@index([tenantId, isActive])  // For filtering active users
  @@map("users")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  endpoint  String   @unique
  keys      Json     // Stores p256dh and auth keys
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

model Student {
  id              String        @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  admissionNumber String        
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  guardianName    String?
  guardianPhone   String?
  guardianEmail   String?
  address         String?
  status          StudentStatus @default(ACTIVE)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  classId         String
  class           Class         @relation(fields: [classId], references: [id])
  
  scholarshipId   String?
  scholarship     Scholarship?  @relation(fields: [scholarshipId], references: [id])

  payments        Payment[]
  attendance      Attendance[]
  feeStructures   StudentFeeStructure[]
  classMovements  ClassMovementLog[]
  
  parentId        String?
  parent          User?         @relation("ParentChildren", fields: [parentId], references: [id])
  
  userId          String?       @unique
  user            User?         @relation(fields: [userId], references: [id])

  assessmentResults AssessmentResult[]
  termResults       TermResult[]
  termReports       StudentTermReport[]
  submissions     AssessmentSubmission[]

  // Admission number unique per tenant
  @@unique([tenantId, admissionNumber])
  @@index([tenantId])
  @@index([tenantId, status])              // Filter active/inactive students
  @@index([tenantId, classId])             // Class roster queries
  @@index([tenantId, createdAt])           // Recent enrollments
  @@map("students")
}

model Class {
  id             String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name           String
  gradeLevel     Int
  teacherId      String
  teacher        User     @relation(fields: [teacherId], references: [id])
  academicTermId String
  academicTerm   AcademicTerm @relation(fields: [academicTermId], references: [id])
  
  students       Student[]
  attendance     Attendance[]
  subjects       Subject[] @relation("ClassSubjects")
  
  incomingMovements ClassMovementLog[] @relation("ToClass")
  outgoingMovements ClassMovementLog[] @relation("FromClass")
  
  assessments    Assessment[]
  termResults    TermResult[]
  termReports    StudentTermReport[]
  timetablePeriods TimetablePeriod[]
  topicProgress  TopicProgress[]
  lessonPlans    LessonPlan[]
  forums         Forum[]

  @@index([tenantId])
  @@map("classes")
}

model Subject {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String
  code      String   
  description String?
  department  String?
  isOptional  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classes   Class[]  @relation("ClassSubjects")
  assessments Assessment[]
  termResults TermResult[]
  timetablePeriods TimetablePeriod[]
  topics          Topic[]
  lessonPlans     LessonPlan[]
  forums          Forum[]
  forums          Forum[]

  // Subject code unique per tenant
  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("subjects")
}

model AcademicTerm {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  classes      Class[]
  feeTemplates FeeTemplate[]
  assessments  Assessment[]
  termResults  TermResult[]
  studentReports StudentTermReport[]
  timetablePeriods TimetablePeriod[]
  lessonPlans    LessonPlan[]

  @@index([tenantId])
  @@map("academic_terms")
}

// NOTE: SchoolSettings is DEPRECATED - use Tenant model instead
// Keeping for backward compatibility during migration
model SchoolSettings {
  id                String   @id @default(uuid())
  schoolName        String   @default("My School")
  schoolAddress     String?
  schoolPhone       String?
  schoolEmail       String?
  schoolWebsite     String?
  logoUrl           String?
  
  // Theme Settings
  primaryColor      String   @default("#2563eb")
  secondaryColor    String   @default("#475569")
  accentColor       String   @default("#f59e0b")

  // System Configuration (DEPRECATED - use Tenant.currentTermId)
  currentTermId     String?  @unique

  updatedAt         DateTime @updatedAt

  @@map("school_settings")
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
}

model Notification {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      NotificationType @default(INFO)
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("notifications")
}

model FeeTemplate {
  id              String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name            String
  amount          Decimal  @db.Decimal(10, 2)
  academicTermId  String
  academicTerm    AcademicTerm @relation(fields: [academicTermId], references: [id])
  applicableGrade Int

  studentFeeStructures StudentFeeStructure[]

  @@index([tenantId])
  @@map("fee_templates")
}

model StudentFeeStructure {
  id            String   @id @default(uuid())
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id])
  feeTemplateId String
  feeTemplate   FeeTemplate @relation(fields: [feeTemplateId], references: [id])
  amountDue     Decimal  @db.Decimal(10, 2)
  amountPaid    Decimal  @db.Decimal(10, 2) @default(0)
  dueDate       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([studentId, feeTemplateId])
  @@map("student_fee_structures")
}

model Payment {
  id              String        @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  paymentDate     DateTime      @default(now())
  method          PaymentMethod
  transactionId   String?       @unique  // Auto-generated TXN-XXXXXXXX
  notes           String?                // Optional payment notes
  status          PaymentStatus @default(COMPLETED)
  voidReason      String?
  voidedAt        DateTime?
  voidedByUserId  String?
  voidedBy        User?         @relation("VoidedPayments", fields: [voidedByUserId], references: [id])
  recordedByUserId String
  recordedBy      User          @relation("RecordedPayments", fields: [recordedByUserId], references: [id])
  createdAt       DateTime      @default(now())

  @@index([tenantId])
  @@index([tenantId, paymentDate])        // Financial reports
  @@index([tenantId, studentId])          // Student payment history
  @@index([tenantId, method, paymentDate]) // Payment method analytics
  @@index([transactionId])                // Transaction lookup
  @@index([status])                       // Filter by status
  @@map("payments")
}

model Attendance {
  id               String           @id @default(uuid())
  
  // Multi-tenant relation
  tenantId         String
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  studentId        String
  student          Student          @relation(fields: [studentId], references: [id])
  classId          String
  class            Class            @relation(fields: [classId], references: [id])
  date             DateTime
  status           AttendanceStatus
  reason           String?          // Reason for absence/lateness
  recordedByUserId String
  recordedBy       User             @relation(fields: [recordedByUserId], references: [id])

  @@index([tenantId])
  @@index([tenantId, date])                // Daily attendance
  @@index([tenantId, studentId, date])     // Student attendance history
  @@index([tenantId, classId, date])       // Class attendance reports
  @@map("attendance")
}

model ClassMovementLog {
  id              String   @id @default(uuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id])
  fromClassId     String?
  fromClass       Class?   @relation("FromClass", fields: [fromClassId], references: [id])
  toClassId       String
  toClass         Class    @relation("ToClass", fields: [toClassId], references: [id])
  reason          String?
  changedByUserId String?
  changedBy       User?    @relation(fields: [changedByUserId], references: [id])
  createdAt       DateTime @default(now())

  @@map("class_movement_logs")
}

model Assessment {
  id             String         @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title          String
  type           AssessmentType
  description    String?
  
  classId        String
  class          Class          @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject        @relation(fields: [subjectId], references: [id])
  termId         String
  term           AcademicTerm   @relation(fields: [termId], references: [id])
  
  totalMarks     Decimal        @db.Decimal(5, 2)
  weight         Decimal        @db.Decimal(5, 2) // Percentage weight (e.g., 30 for 30%)
  date           DateTime
  
  results        AssessmentResult[]
  
  isOnline       Boolean @default(false)
  durationMinutes Int?
  startTime      DateTime?
  endTime        DateTime?
  
  questions      Question[]
  submissions    AssessmentSubmission[]

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("assessments")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

model Question {
  id            String @id @default(uuid())
  assessmentId  String
  assessment    Assessment @relation(fields: [assessmentId], references: [id])
  text          String
  type          QuestionType
  points        Int
  options       QuestionOption[]
  correctAnswer String? // For auto-grading
  
  responses     StudentResponse[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("questions")
}

model QuestionOption {
  id         String @id @default(uuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  text       String
  isCorrect  Boolean @default(false)
  
  @@map("question_options")
}

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

model AssessmentSubmission {
  id           String @id @default(uuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  studentId    String
  student      Student @relation(fields: [studentId], references: [id])
  startedAt    DateTime @default(now())
  submittedAt  DateTime?
  score        Decimal?
  status       SubmissionStatus @default(IN_PROGRESS)
  
  responses    StudentResponse[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([assessmentId, studentId])
  @@map("assessment_submissions")
}

model StudentResponse {
  id           String @id @default(uuid())
  submissionId String
  submission   AssessmentSubmission @relation(fields: [submissionId], references: [id])
  questionId   String
  question     Question @relation(fields: [questionId], references: [id])
  answerText   String?
  selectedOptionId String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([submissionId, questionId])
  @@map("student_responses")
}

model AssessmentResult {
  id             String     @id @default(uuid())
  assessmentId   String
  assessment     Assessment @relation(fields: [assessmentId], references: [id])
  studentId      String
  student        Student    @relation(fields: [studentId], references: [id])
  
  score          Decimal    @db.Decimal(5, 2)
  remarks        String?
  
  gradedByUserId String
  gradedBy       User       @relation(fields: [gradedByUserId], references: [id])
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([assessmentId, studentId])
  @@map("assessment_results")
}

model TermResult {
  id             String       @id @default(uuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject      @relation(fields: [subjectId], references: [id])
  termId         String
  term           AcademicTerm @relation(fields: [termId], references: [id])
  
  totalScore     Decimal      @db.Decimal(5, 2)
  grade          String?
  remarks        String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([studentId, subjectId, termId])
  @@map("term_results")
}

model GradingScale {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  grade     String   // "A"
  minScore  Int      // 80
  maxScore  Int      // 100
  remark    String?  // "Excellent"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("grading_scales")
}

model StudentTermReport {
  id             String       @id @default(uuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  termId         String
  term           AcademicTerm @relation(fields: [termId], references: [id])
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  
  totalAttendance Int?        // Days present
  totalDays       Int?        // Total school days
  
  classTeacherRemark String?
  principalRemark    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([studentId, termId])
  @@map("student_term_reports")
}

model TimetablePeriod {
  id             String       @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject      @relation(fields: [subjectId], references: [id])
  teacherId      String
  teacher        User         @relation(fields: [teacherId], references: [id])
  dayOfWeek      DayOfWeek
  startTime      String       // "08:00"
  endTime        String       // "08:40"
  academicTermId String
  academicTerm   AcademicTerm @relation(fields: [academicTermId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([tenantId])
  @@map("timetable_periods")
}

model Topic {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  gradeLevel  Int      // 1-12
  orderIndex  Int      @default(0)

  progress    TopicProgress[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("topics")
}

model TopicProgress {
  id          String   @id @default(uuid())
  topicId     String
  topic       Topic    @relation(fields: [topicId], references: [id])
  classId     String
  class       Class    @relation(fields: [classId], references: [id])
  status      TopicStatus @default(PENDING)
  completedAt DateTime?

  updatedAt   DateTime @updatedAt

  @@unique([topicId, classId])
  @@map("topic_progress")
}

model LessonPlan {
  id            String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  teacherId     String
  teacher       User     @relation(fields: [teacherId], references: [id])
  classId       String
  class         Class    @relation(fields: [classId], references: [id])
  subjectId     String
  subject       Subject  @relation(fields: [subjectId], references: [id])
  termId        String
  term          AcademicTerm @relation(fields: [termId], references: [id])
  
  weekStartDate DateTime
  title         String
  content       String   @db.Text
  fileUrl       String?  // For uploaded files

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@map("lesson_plans")
}

model Conversation {
  id        String    @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  participants ConversationParticipant[]
  messages     Message[]

  @@index([tenantId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@map("messages")
}

model Scholarship {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  percentage  Decimal  @db.Decimal(5, 2) // 0-100
  description String?

  students    Student[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("scholarships")
}

model NotificationTemplate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String   // e.g. "PAYMENT_RECEIPT"
  type      String   // "EMAIL", "SMS"
  subject   String?  // For Email
  content   String   @db.Text
  variables String[] // JSON array of available vars ["studentName", "amount"]
  
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name, type])
  @@index([tenantId])
  @@map("notification_templates")
}

// ==========================================
// AUDIT LOGGING - Track all important actions
// ==========================================

model AuditLog {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Who performed the action
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // What action was performed
  action      String   // CREATE, UPDATE, DELETE, LOGIN, PAYMENT, EXPORT, etc.
  entityType  String   // Student, Payment, User, etc.
  entityId    String?  // ID of the affected entity
  
  // Before/After values for tracking changes
  oldValue    Json?    // Previous state (for UPDATE/DELETE)
  newValue    Json?    // New state (for CREATE/UPDATE)
  
  // Additional metadata
  metadata    Json?    // Any extra context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId])
  @@index([tenantId, action])
  @@map("audit_logs")
}

// ==========================================
// USAGE METRICS - Track feature usage
// ==========================================

model UsageMetric {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // What metric is being tracked
  metricType  String   // SMS_SENT, EMAILS_SENT, API_CALLS, STORAGE_MB, REPORTS_GENERATED
  value       Int      @default(0)
  
  // Time period for aggregation
  periodStart DateTime @default(now())
  periodEnd   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, metricType, periodStart])
  @@unique([tenantId, metricType, periodStart])
  @@map("usage_metrics")
}




model PlatformAnnouncement {
  id          String   @id @default(uuid())
  title       String
  message     String
  type        String   // INFO, WARNING, SUCCESS, ERROR
  isActive    Boolean  @default(true)
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt // Added for consistency

  @@map("platform_announcements")
}

// ==========================================
// SECURITY & COMPLIANCE
// ==========================================

enum LoginAttemptStatus {
  SUCCESS
  FAILED_PASSWORD
  FAILED_USER_NOT_FOUND
  FAILED_ACCOUNT_LOCKED
  FAILED_2FA
}

enum SecurityEventType {
  FAILED_LOGIN
  SUCCESSFUL_LOGIN
  PASSWORD_CHANGE
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_ACTIVITY
  DATA_EXPORT
  DATA_DELETION
  PERMISSION_CHANGE
}

// Security Event Log - Track all security-related events
model SecurityEvent {
  id          String   @id @default(uuid())
  
  // Tenant relation (null for platform-level events)
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // User involved (null if user not found)
  userId      String?
  userEmail   String   // Always store email even if user not found
  
  // Event details
  eventType   SecurityEventType
  status      LoginAttemptStatus?
  ipAddress   String?
  userAgent   String?
  location    String?  // Geo-location if available
  
  // Additional context
  metadata    Json?    // Extra details about the event
  riskScore   Int      @default(0) // 0-100, higher = more suspicious
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, eventType, createdAt])
  @@index([userEmail, createdAt])
  @@index([ipAddress, createdAt])
  @@index([riskScore])
  @@map("security_events")
}

// Account Lock Status - Track locked accounts
model AccountLock {
  id              String   @id @default(uuid())
  
  tenantId        String?
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId          String?
  userEmail       String   @unique
  
  isLocked        Boolean  @default(true)
  lockReason      String   // "Too many failed attempts", "Admin action", etc.
  failedAttempts  Int      @default(0)
  
  lockedAt        DateTime @default(now())
  lockedUntil     DateTime? // Auto-unlock time
  unlockedAt      DateTime?
  unlockedBy      String?  // Admin who unlocked
  
  @@index([userEmail, isLocked])
  @@map("account_locks")
}

// Two-Factor Authentication Settings
model TwoFactorAuth {
  id          String   @id @default(uuid())
  
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  isEnabled   Boolean  @default(false)
  secret      String?  // TOTP secret
  backupCodes String[] // Encrypted backup codes
  
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("two_factor_auth")
}

// GDPR Data Export Requests
model DataExportRequest {
  id          String   @id @default(uuid())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  requestedBy String   // User ID who requested
  requestedByEmail String
  
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  exportType  String   // FULL, STUDENTS_ONLY, PAYMENTS_ONLY, etc.
  
  fileUrl     String?  // S3/storage URL of exported file
  fileSize    Int?     // Size in bytes
  expiresAt   DateTime? // When the download link expires
  
  completedAt DateTime?
  failureReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId, status])
  @@map("data_export_requests")
}

// Data Deletion Requests (GDPR Right to be Forgotten)
model DataDeletionRequest {
  id          String   @id @default(uuid())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  requestedBy String   // User ID who requested
  requestedByEmail String
  
  entityType  String   // STUDENT, USER, PAYMENT, etc.
  entityId    String   // ID of entity to delete
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  reason      String?  // Reason for deletion
  
  approvedBy  String?  // Admin who approved
  approvedAt  DateTime?
  
  completedAt DateTime?
  deletedData Json?    // Backup of deleted data
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId, status])
  @@map("data_deletion_requests")
}

// Data Retention Policies
model DataRetentionPolicy {
  id          String   @id @default(uuid())
  
  tenantId    String?  // Null for platform-wide policies
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  entityType  String   // AUDIT_LOGS, PAYMENTS, STUDENTS, etc.
  retentionDays Int    // How many days to keep data
  
  isActive    Boolean  @default(true)
  autoDelete  Boolean  @default(false) // Automatically delete after retention period
  
  lastRunAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, entityType])
  @@map("data_retention_policies")
}

// Backup Status Tracking
model BackupLog {
  id          String   @id @default(uuid())
  
  backupType  String   // FULL, INCREMENTAL, TENANT_SPECIFIC
  tenantId    String?  // Null for full platform backups
  
  status      String   // STARTED, IN_PROGRESS, COMPLETED, FAILED
  
  fileSize    BigInt?  // Size in bytes
  fileLocation String? // S3/storage path
  
  recordCount Int?     // Number of records backed up
  duration    Int?     // Duration in seconds
  
  startedAt   DateTime @default(now())
  completedAt DateTime?
  failureReason String?
  
  @@index([tenantId, status, startedAt])
  @@map("backup_logs")
}

// ==========================================
// INVOICE MANAGEMENT & REVENUE RECONCILIATION
// ==========================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum InvoiceType {
  SUBSCRIPTION
  ONE_TIME
  RECURRING
}

// Invoice Model
model Invoice {
  id              String   @id @default(uuid())
  
  // Tenant relation
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Invoice details
  invoiceNumber   String   @unique // INV-2024-0001
  invoiceType     InvoiceType @default(SUBSCRIPTION)
  status          InvoiceStatus @default(DRAFT)
  
  // Amounts
  subtotal        Decimal  @db.Decimal(12, 2)
  taxAmount       Decimal  @db.Decimal(12, 2) @default(0)
  discountAmount  Decimal  @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal  @db.Decimal(12, 2)
  paidAmount      Decimal  @db.Decimal(12, 2) @default(0)
  balanceAmount   Decimal  @db.Decimal(12, 2)
  
  currency        String   @default("ZMW")
  
  // Dates
  issueDate       DateTime @default(now())
  dueDate         DateTime
  paidDate        DateTime?
  sentDate        DateTime?
  
  // Related payment
  subscriptionPaymentId String? @unique
  subscriptionPayment   SubscriptionPayment? @relation(fields: [subscriptionPaymentId], references: [id])
  
  // Invoice items
  items           InvoiceItem[]
  
  // Payment tracking
  payments        InvoicePayment[]
  
  // PDF and email
  pdfUrl          String?
  emailSent       Boolean  @default(false)
  emailSentAt     DateTime?
  
  // Reminders
  remindersSent   Int      @default(0)
  lastReminderAt  DateTime?
  
  // Notes
  notes           String?  @db.Text
  internalNotes   String?  @db.Text
  
  // Metadata
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId, status])
  @@index([invoiceNumber])
  @@index([status, dueDate])
  @@map("invoices")
}

// Invoice Line Items
model InvoiceItem {
  id          String   @id @default(uuid())
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  amount      Decimal  @db.Decimal(12, 2)
  
  // Optional metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@map("invoice_items")
}

// Invoice Payments (track partial payments)
model InvoicePayment {
  id              String   @id @default(uuid())
  
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  amount          Decimal  @db.Decimal(12, 2)
  paymentMethod   String   // MOBILE_MONEY, BANK_TRANSFER, CARD, etc.
  paymentReference String?
  
  paidAt          DateTime @default(now())
  notes           String?
  
  // Reconciliation
  reconciled      Boolean  @default(false)
  reconciledAt    DateTime?
  reconciledBy    String?
  
  createdAt       DateTime @default(now())
  
  @@index([invoiceId])
  @@map("invoice_payments")
}

// Payment Reconciliation
model PaymentReconciliation {
  id              String   @id @default(uuid())
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Tenant (null for platform-wide)
  tenantId        String?
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Summary
  totalInvoiced   Decimal  @db.Decimal(12, 2)
  totalPaid       Decimal  @db.Decimal(12, 2)
  totalOutstanding Decimal @db.Decimal(12, 2)
  totalOverdue    Decimal  @db.Decimal(12, 2)
  
  invoiceCount    Int
  paidInvoiceCount Int
  overdueInvoiceCount Int
  
  // Discrepancies
  discrepancyCount Int     @default(0)
  discrepancyAmount Decimal @db.Decimal(12, 2) @default(0)
  
  // Status
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  
  // Report
  reportUrl       String?
  
  // Metadata
  performedBy     String?
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  
  @@index([tenantId, periodStart])
  @@index([status])
  @@map("payment_reconciliations")
}

// Missing Payment Alerts
model MissingPaymentAlert {
  id              String   @id @default(uuid())
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  invoiceId       String?
  
  expectedAmount  Decimal  @db.Decimal(12, 2)
  expectedDate    DateTime
  
  alertType       String   // OVERDUE, MISSING, PARTIAL
  severity        String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  description     String
  
  resolved        Boolean  @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
  
  createdAt       DateTime @default(now())
  
  @@index([tenantId, resolved])
  @@index([severity, resolved])
  @@map("missing_payment_alerts")
}



// ==========================================
// ENHANCED CRM MODELS
// ==========================================

model Email {
  id              String   @id @default(uuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  toEmail         String
  toName          String?
  subject         String
  body            String   @db.Text
  
  templateId      String?
  template        EmailTemplate? @relation(fields: [templateId], references: [id])
  
  ccEmails        String[]
  bccEmails       String[]
  
  sentById        String
  sentBy          PlatformUser @relation(fields: [sentById], references: [id])
  
  status          String   @default("PENDING") // PENDING, SENT, FAILED
  sentAt          DateTime?
  errorMessage    String?
  
  openCount       Int      @default(0)
  clickCount      Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([leadId])
  @@index([sentById])
  @@map("crm_emails")
}

model EmailTemplate {
  id              String   @id @default(uuid())
  name            String
  subject         String
  body            String   @db.Text
  category        String?
  variables       String[]
  
  createdById     String?
  createdBy       PlatformUser? @relation(fields: [createdById], references: [id])
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  emails          Email[]
  
  @@map("crm_email_templates")
}

model Document {
  id              String   @id @default(uuid())
  name            String
  description     String?
  
  fileUrl         String
  fileSize        Int?
  fileType        String?
  mimeType        String?
  category        String?
  
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id])
  
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  
  uploadedById    String
  uploadedBy      PlatformUser @relation(fields: [uploadedById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([leadId])
  @@index([dealId])
  @@map("crm_documents")
}

model FollowUpReminder {
  id              String   @id @default(uuid())
  
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  title           String
  description     String?
  reminderDate    DateTime
  reminderType    String?
  priority        String?
  
  assignedToId    String
  assignedTo      PlatformUser @relation(fields: [assignedToId], references: [id])
  
  status          String   @default("PENDING") // PENDING, COMPLETED, SNOOZED
  completedAt     DateTime?
  snoozeUntil     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([assignedToId])
  @@index([reminderDate])
  @@map("crm_reminders")
}

model LeadScore {
  id              String   @id @default(uuid())
  
  leadId          String   @unique
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  engagementScore Int      @default(0)
  emailOpens      Int      @default(0)
  emailClicks     Int      @default(0)
  
  fitScore        Int      @default(0)
  intentScore     Int      @default(0)
  
  totalScore      Int      @default(0)
  grade           String   @default("D")
  
  demoRequested   Boolean  @default(false)
  budgetConfirmed Boolean  @default(false)
  decisionMaker   Boolean  @default(false)
  
  lastCalculatedAt DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("crm_lead_scores")
}

model Quote {
  id              String   @id @default(uuid())
  quoteNumber     String   @unique
  
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  
  title           String
  description     String?
  
  subtotal        Decimal  @db.Decimal(12, 2)
  taxAmount       Decimal  @db.Decimal(12, 2) @default(0)
  discountAmount  Decimal  @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal  @db.Decimal(12, 2)
  currency        String   @default("ZMW")
  
  validUntil      DateTime
  paymentTerms    String?
  deliveryTerms   String?
  notes           String?
  
  status          String   @default("DRAFT") // DRAFT, SENT, VIEWED, ACCEPTED, REJECTED
  
  createdById     String
  createdBy       PlatformUser @relation(fields: [createdById], references: [id])
  
  sentAt          DateTime?
  viewedAt        DateTime?
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  
  items           QuoteItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("crm_quotes")
}

model QuoteItem {
  id              String   @id @default(uuid())
  
  quoteId         String
  quote           Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  description     String
  quantity        Decimal  @db.Decimal(10, 2)
  unitPrice       Decimal  @db.Decimal(12, 2)
  amount          Decimal  @db.Decimal(12, 2)
  
  planTier        String?
  billingCycle    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("crm_quote_items")
}

model CrmReport {
  id              String   @id @default(uuid())
  
  reportType      String   // SALES_PERFORMANCE, CONVERSION, REVENUE
  periodStart     DateTime
  periodEnd       DateTime
  
  data            Json
  
  totalLeads      Int      @default(0)
  convertedLeads  Int      @default(0)
  conversionRate  Decimal  @db.Decimal(5, 2) @default(0)
  totalRevenue    Decimal  @db.Decimal(12, 2) @default(0)
  avgDealSize     Decimal  @db.Decimal(12, 2) @default(0)
  avgSalesCycle   Int      @default(0) // Days
  
  generatedById   String
  generatedBy     PlatformUser @relation(fields: [generatedById], references: [id])
  
  createdAt       DateTime @default(now())
  
  @@map("crm_reports")
}

// ==========================================
// LMS FEATURES - Phase 1
// ==========================================

enum HomeworkType {
  CLASSWORK
  HOMEWORK
  PROJECT
  RESEARCH
  PRACTICE
}

enum ResourceType {
  PDF
  VIDEO
  DOCUMENT
  LINK
  IMAGE
  PAST_PAPER
  NOTES
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
}

// Subject Content (Links class to subject with teacher for LMS)
model SubjectContent {
  id              String   @id @default(uuid())
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  classId         String
  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  subjectId       String
  subject         Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  academicTermId  String
  academicTerm    AcademicTerm @relation(fields: [academicTermId], references: [id], onDelete: Cascade)
  
  teacherId       String
  teacher         User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // ECZ Curriculum alignment
  curriculumCode  String?
  
  // Relations
  homework        Homework[]
  resources       Resource[]
  lessons         Lesson[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([classId, subjectId, academicTermId])
  @@index([tenantId])
  @@index([teacherId])
  @@map("subject_content")
}

// Homework
model Homework {
  id              String   @id @default(uuid())
  
  subjectContentId String
  subjectContent  SubjectContent @relation(fields: [subjectContentId], references: [id], onDelete: Cascade)
  
  topicId         String?
  topic           Topic?   @relation(fields: [topicId], references: [id], onDelete: SetNull)
  
  title           String
  description     String?  @db.Text
  instructions    String?  @db.Text
  type            HomeworkType @default(HOMEWORK)
  
  assignedDate    DateTime @default(now())
  dueDate         DateTime?
  maxPoints       Decimal? @db.Decimal(5, 2)
  
  requiresSubmission Boolean @default(false)
  allowLateSubmission Boolean @default(true)
  
  attachments     String[] // File URLs
  
  submissions     HomeworkSubmission[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([subjectContentId])
  @@index([dueDate])
  @@map("homework")
}

// Homework Submissions
model HomeworkSubmission {
  id              String   @id @default(uuid())
  
  homeworkId      String
  homework        Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  submittedAt     DateTime @default(now())
  isLate          Boolean  @default(false)
  
  // Submission content
  content         String?  @db.Text
  attachments     String[] // File URLs
  
  // Grading
  marks           Decimal? @db.Decimal(5, 2)
  maxMarks        Decimal? @db.Decimal(5, 2)
  feedback        String?  @db.Text
  gradedAt        DateTime?
  gradedByUserId  String?
  gradedBy        User?    @relation(fields: [gradedByUserId], references: [id], onDelete: SetNull)
  
  status          SubmissionStatus @default(DRAFT)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([homeworkId, studentId])
  @@index([studentId])
  @@index([homeworkId])
  @@map("homework_submission")
}

// Learning Resources
model Resource {
  id              String   @id @default(uuid())
  
  subjectContentId String
  subjectContent  SubjectContent @relation(fields: [subjectContentId], references: [id], onDelete: Cascade)
  
  topicId         String?
  topic           Topic?   @relation(fields: [topicId], references: [id], onDelete: SetNull)
  
  title           String
  description     String?  @db.Text
  type            ResourceType
  
  // Content
  fileUrl         String?
  externalUrl     String?
  content         String?  @db.Text
  
  // Metadata
  fileSize        Int?
  duration        Int?     // For videos (seconds)
  
  isDownloadable  Boolean  @default(true)
  
  lessons         LessonResource[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([subjectContentId])
  @@map("resource")
}

// Lesson (Daily/Weekly lessons)
model Lesson {
  id              String   @id @default(uuid())
  
  subjectContentId String
  subjectContent  SubjectContent @relation(fields: [subjectContentId], references: [id], onDelete: Cascade)
  
  topicId         String?
  topic           Topic?   @relation(fields: [topicId], references: [id], onDelete: SetNull)
  
  title           String
  date            DateTime
  period          Int?     // Period 1, 2, 3...
  
  // Lesson content
  objectives      String[] // Learning objectives
  notes           String?  @db.Text
  
  // Resources used
  resources       LessonResource[]
  
  // Attendance
  attendanceRecorded Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([subjectContentId])
  @@index([date])
  @@map("lesson")
}

// Lesson Resources (Many-to-Many)
model LessonResource {
  lessonId        String
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  resourceId      String
  resource        Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@id([lessonId, resourceId])
  @@map("lesson_resource")
}

// Update existing models to add LMS relations
// Add to Tenant model
model Tenant {
  // ... existing fields
  subjectContent  SubjectContent[]
}

// Add to Class model
model Class {
  // ... existing fields
  subjectContent  SubjectContent[]
}

// Add to Subject model
model Subject {
  // ... existing fields
  subjectContent  SubjectContent[]
}

// Add to AcademicTerm model
model AcademicTerm {
  // ... existing fields
  subjectContent  SubjectContent[]
}

// Add to User model
model User {
  // ... existing fields
  subjectContentTeaching SubjectContent[]
  homeworkGraded        HomeworkSubmission[]
}

// Add to Student model
model Student {
  // ... existing fields
  homeworkSubmissions   HomeworkSubmission[]
}

// Add to Topic model
model Topic {
  // ... existing fields
  homework        Homework[]
  resources       Resource[]
  lessons         Lesson[]
}

// ==========================================
// LMS - FORUMS & DISCUSSIONS
// ==========================================

enum ForumType {
  GENERAL
  QA
  ANNOUNCEMENT
  DISCUSSION
}

enum PostStatus {
  ACTIVE
  LOCKED
  ARCHIVED
}

model Forum {
  id          String   @id @default(uuid())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id])
  
  subjectId   String?
  subject     Subject? @relation(fields: [subjectId], references: [id])
  
  name        String
  description String?
  type        ForumType @default(GENERAL)
  isActive    Boolean  @default(true)
  
  createdById String
  createdBy   User     @relation("ForumCreator", fields: [createdById], references: [id])
  
  posts       ForumPost[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([classId])
  @@index([subjectId])
  @@map("forums")
}

model ForumPost {
  id          String   @id @default(uuid())
  
  forumId     String
  forum       Forum    @relation(fields: [forumId], references: [id], onDelete: Cascade)
  
  parentPostId String?
  parentPost  ForumPost? @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: Cascade)
  replies     ForumPost[] @relation("PostReplies")
  
  userId      String
  user        User     @relation("ForumPosts", fields: [userId], references: [id])
  
  title       String?
  content     String   @db.Text
  attachments String[]
  
  isPinned    Boolean  @default(false)
  isAnswered  Boolean  @default(false)
  status      PostStatus @default(ACTIVE)
  
  likes       Int      @default(0)
  views       Int      @default(0)
  
  postLikes   PostLike[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([forumId])
  @@index([parentPostId])
  @@index([userId])
  @@index([createdAt])
  @@map("forum_posts")
}

model PostLike {
  id        String   @id @default(uuid())
  
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation("PostLikes", fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
}

// ==========================================
// LMS - ANNOUNCEMENTS
// ==========================================

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AnnouncementCategory {
  GENERAL
  EXAM
  EVENT
  HOLIDAY
  EMERGENCY
  ACADEMIC
  ADMINISTRATIVE
}

model Announcement {
  id              String   @id @default(uuid())
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title           String
  content         String   @db.Text
  category        AnnouncementCategory @default(GENERAL)
  priority        AnnouncementPriority @default(NORMAL)
  attachments     String[]
  
  targetAudience  String   @default("ALL") // ALL, TEACHERS, PARENTS, STUDENTS
  classIds        String[] // Empty = all classes
  
  sendSMS         Boolean  @default(false)
  sendEmail       Boolean  @default(false)
  
  scheduledFor    DateTime?
  publishedAt     DateTime?
  expiresAt       DateTime?
  
  requiresAcknowledgment Boolean @default(false)
  
  createdById     String
  createdBy       User     @relation("AnnouncementCreator", fields: [createdById], references: [id])
  
  reads           AnnouncementRead[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([publishedAt])
  @@index([priority])
  @@map("announcements")
}

model AnnouncementRead {
  id              String   @id @default(uuid())
  
  announcementId  String
  announcement    Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation("AnnouncementReads", fields: [userId], references: [id])
  
  readAt          DateTime @default(now())
  acknowledgedAt  DateTime?
  
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_reads")
}


// ==========================================
// FORUMS & DISCUSSIONS
// ==========================================

enum ForumType {
  GENERAL
  SUBJECT
  CLASS
  QA
}

model Forum {
  id          String      @id @default(uuid())
  tenantId    String
  name        String
  description String?
  type        ForumType   @default(GENERAL)
  classId     String?
  subjectId   String?
  createdById String
  isPinned    Boolean     @default(false)
  isLocked    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  class       Class?      @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject     Subject?    @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  createdBy   User        @relation(fields: [createdById], references: [id], onDelete: Cascade)
  topics      ForumTopic[]

  @@index([tenantId])
  @@index([classId])
  @@index([subjectId])
  @@map("forums")
}

model ForumTopic {
  id          String      @id @default(uuid())
  forumId     String
  title       String
  content     String      @db.Text
  createdById String
  isPinned    Boolean     @default(false)
  isLocked    Boolean     @default(false)
  isResolved  Boolean     @default(false)
  views       Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  forum       Forum       @relation(fields: [forumId], references: [id], onDelete: Cascade)
  createdBy   User        @relation(fields: [createdById], references: [id], onDelete: Cascade)
  posts       ForumPost[]

  @@index([forumId])
  @@index([createdById])
  @@map("forum_topics")
}

model ForumPost {
  id           String      @id @default(uuid())
  topicId      String
  content      String      @db.Text
  createdById  String
  parentPostId String?
  isAnswer     Boolean     @default(false)
  likes        Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  topic        ForumTopic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  createdBy    User        @relation(fields: [createdById], references: [id], onDelete: Cascade)
  parentPost   ForumPost?  @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: SetNull)
  replies      ForumPost[] @relation("PostReplies")
  postLikes    ForumPostLike[]

  @@index([topicId])
  @@index([createdById])
  @@index([parentPostId])
  @@map("forum_posts")
}

model ForumPostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("forum_post_likes")
}

// ==========================================
// ANNOUNCEMENTS
// ==========================================

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AnnouncementCategory {
  GENERAL
  EXAM
  EVENT
  HOLIDAY
  EMERGENCY
  ACADEMIC
  ADMINISTRATIVE
}

model Announcement {
  id             String                @id @default(uuid())
  tenantId       String
  title          String
  content        String                @db.Text
  category       AnnouncementCategory  @default(GENERAL)
  priority       AnnouncementPriority  @default(NORMAL)
  createdById    String
  publishAt      DateTime?
  expiresAt      DateTime?
  isPublished    Boolean               @default(true)
  sendSMS        Boolean               @default(false)
  sendEmail      Boolean               @default(false)
  targetAudience String                @default("ALL") // ALL, TEACHERS, PARENTS, STUDENTS
  classIds       String[]
  attachments    String[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  tenant         Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy      User                  @relation(fields: [createdById], references: [id], onDelete: Cascade)
  reads          AnnouncementRead[]

  @@index([tenantId])
  @@index([createdById])
  @@index([publishAt])
  @@map("announcements")
}

model AnnouncementRead {
  id             String       @id @default(uuid())
  announcementId String
  userId         String
  readAt         DateTime     @default(now())

  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_reads")
}
