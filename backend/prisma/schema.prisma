generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  BURSAR
  TEACHER
  SECRETARY
  PARENT
  STUDENT
}

enum Gender {
  MALE
  FEMALE
}

enum StudentStatus {
  ACTIVE
  TRANSFERRED
  GRADUATED
  DROPPED_OUT
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_DEPOSIT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum AssessmentType {
  EXAM
  TEST
  QUIZ
  HOMEWORK
  PROJECT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum TopicStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// ==========================================
// MULTI-TENANT ENUMS
// ==========================================

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
}

enum PlatformRole {
  PLATFORM_SUPERADMIN
  PLATFORM_SUPPORT
  PLATFORM_SALES
}

// ==========================================
// TENANT (SCHOOL) - Core Multi-Tenant Model
// ==========================================

model Tenant {
  id              String   @id @default(uuid())
  name            String   // "Lusaka Academy"
  slug            String   @unique // "lusaka-academy" (for subdomain)
  domain          String?  @unique // custom domain support
  
  // Branding
  logoUrl         String?
  primaryColor    String   @default("#2563eb")
  secondaryColor  String   @default("#475569")
  accentColor     String   @default("#f59e0b")
  
  // Contact Info
  email           String
  phone           String?
  address         String?
  city            String?
  country         String   @default("ZM")
  website         String?
  
  // Subscription & Billing
  tier            SubscriptionTier @default(FREE)
  status          SubscriptionStatus @default(TRIAL)
  trialEndsAt     DateTime?
  subscriptionStartedAt DateTime?
  subscriptionEndsAt    DateTime?
  
  // Feature Limits (based on tier, can be overridden)
  maxStudents     Int      @default(50)
  maxTeachers     Int      @default(5)
  maxUsers        Int      @default(10)
  maxClasses      Int      @default(5)
  maxStorageGB    Int      @default(1)
  
  // Feature Flags (what's enabled for this tenant)
  smsEnabled              Boolean @default(false)
  emailEnabled            Boolean @default(true)
  onlineAssessmentsEnabled Boolean @default(false)
  parentPortalEnabled     Boolean @default(false)
  reportCardsEnabled      Boolean @default(true)
  attendanceEnabled       Boolean @default(true)
  feeManagementEnabled    Boolean @default(true)
  chatEnabled             Boolean @default(false)
  advancedReportsEnabled  Boolean @default(false)
  apiAccessEnabled        Boolean @default(false)
  timetableEnabled        Boolean @default(true)
  syllabusEnabled         Boolean @default(false)
  
  // SMTP Settings (per-tenant email configuration)
  smtpHost        String?
  smtpPort        Int?
  smtpSecure      Boolean  @default(true)
  smtpUser        String?
  smtpPassword    String?
  smtpFromEmail   String?
  smtpFromName    String?
  
  // SMS Settings (per-tenant)
  smsProvider     String?  // 'TWILIO', 'AFRICASTALKING'
  smsApiKey       String?
  smsApiSecret    String?
  smsSenderId     String?
  
  // Usage Tracking
  currentStudentCount  Int @default(0)
  currentTeacherCount  Int @default(0)
  currentUserCount     Int @default(0)
  currentStorageUsedMB Int @default(0)
  
  // Current Term Reference
  currentTermId   String?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations to all tenant-scoped entities
  users           User[]
  students        Student[]
  classes         Class[]
  subjects        Subject[]
  academicTerms   AcademicTerm[]
  feeTemplates    FeeTemplate[]
  payments        Payment[]
  attendance      Attendance[]
  assessments     Assessment[]
  gradingScales   GradingScale[]
  scholarships    Scholarship[]
  timetablePeriods TimetablePeriod[]
  topics          Topic[]
  lessonPlans     LessonPlan[]
  notifications   Notification[]
  conversations   Conversation[]
  subscriptionPayments SubscriptionPayment[]
  auditLogs       AuditLog[]
  usageMetrics    UsageMetric[]
  
  @@index([slug])
  @@index([status])
  @@map("tenants")
}

// ==========================================
// PLATFORM USER (Super Admin for all schools)
// ==========================================

model PlatformUser {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  fullName      String
  role          PlatformRole @default(PLATFORM_SUPPORT)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // CRM Relations
  assignedLeads Lead[]    @relation("AssignedLeads")
  ownedDeals    Deal[]    @relation("OwnedDeals")
  activities    Activity[] @relation("PerformedActivities")
  assignedTasks Task[]    @relation("AssignedTasks")
  createdTasks  Task[]    @relation("CreatedTasks")
  
  @@map("platform_users")
}

// ==========================================
// PLATFORM SETTINGS (Centralized Config)
// ==========================================

model PlatformSettings {
  id              String   @id @default("default")
  
  // SMS Gateway Configuration (centralized)
  smsProvider     String   @default("zamtel") // "zamtel", "mtn", "airtel", "twilio", "africastalking"
  smsApiUrl       String?  // API endpoint
  smsApiKey       String?  // API key
  smsApiSecret    String?  // API secret/password
  smsDefaultSenderId String? @default("SYNC") // Default sender ID if tenant doesn't have one
  smsBalanceUnits Int      @default(0) // SMS credits balance
  smsCostPerUnit  Decimal  @db.Decimal(10, 4) @default(0.15) // Cost per SMS in ZMW
  
  // Email Gateway Configuration (centralized)
  emailProvider   String   @default("smtp") // "smtp", "sendgrid", "ses"
  emailApiKey     String?
  emailFromAddress String?
  emailFromName   String?  @default("Sync School Management")
  
  // Platform Branding
  platformName    String   @default("Sync School Management")
  platformLogoUrl String?
  supportEmail    String?
  supportPhone    String?
  
  // Feature Toggles
  allowTenantCustomSms Boolean @default(false) // Allow tenants to use their own SMS credentials
  allowTenantCustomEmail Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("platform_settings")
}

// ==========================================
// CRM ENUMS
// ==========================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  COLD_CALL
  SOCIAL_MEDIA
  TRADE_SHOW
  EMAIL_CAMPAIGN
  PARTNER
  OTHER
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  DEMO
  FOLLOW_UP
  PROPOSAL_SENT
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==========================================
// CRM MODELS
// ==========================================

// Lead - Potential school/customer before becoming a tenant
model Lead {
  id              String   @id @default(uuid())
  
  // School/Organization Info
  schoolName      String
  schoolType      String?  // Primary, Secondary, International, etc.
  website         String?
  
  // Contact Person
  contactName     String
  contactEmail    String
  contactPhone    String?
  contactRole     String?  // Principal, Admin, IT Manager, etc.
  
  // Location
  city            String?
  province        String?
  country         String   @default("Zambia")
  address         String?
  
  // Lead Info
  status          LeadStatus @default(NEW)
  source          LeadSource @default(WEBSITE)
  estimatedStudents Int?     // Estimated student count
  estimatedValue  Decimal?   @db.Decimal(12, 2) // Potential deal value
  interestedTier  SubscriptionTier?
  
  // Assignment
  assignedToId    String?
  assignedTo      PlatformUser? @relation("AssignedLeads", fields: [assignedToId], references: [id])
  
  // Tracking
  lastContactedAt DateTime?
  nextFollowUpAt  DateTime?
  notes           String?   @db.Text
  
  // Conversion
  convertedToTenantId String? @unique
  convertedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  activities      Activity[]
  tasks           Task[]
  deals           Deal[]
  
  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@map("crm_leads")
}

// Deal - Sales opportunity with a lead
model Deal {
  id              String   @id @default(uuid())
  
  // Deal Info
  name            String   // e.g., "Lusaka Academy - Professional Plan"
  value           Decimal  @db.Decimal(12, 2)
  currency        String   @default("ZMW")
  
  // Pipeline Stage
  stage           String   @default("prospecting") // prospecting, qualification, proposal, negotiation, closed_won, closed_lost
  probability     Int      @default(10) // 0-100%
  
  // Related
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  // Plan Info
  proposedTier    SubscriptionTier
  proposedBillingCycle String @default("ANNUAL") // MONTHLY, ANNUAL
  
  // Dates
  expectedCloseDate DateTime?
  actualCloseDate DateTime?
  
  // Assignment
  ownerId         String?
  owner           PlatformUser? @relation("OwnedDeals", fields: [ownerId], references: [id])
  
  // Outcome
  wonReason       String?
  lostReason      String?
  competitorName  String?
  
  notes           String?   @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([stage])
  @@index([ownerId])
  @@index([leadId])
  @@map("crm_deals")
}

// Activity - Calls, emails, meetings tracked for leads
model Activity {
  id              String   @id @default(uuid())
  
  type            ActivityType
  subject         String
  description     String?  @db.Text
  
  // Related
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  
  // Performed by
  performedById   String
  performedBy     PlatformUser @relation("PerformedActivities", fields: [performedById], references: [id])
  
  // Timing
  activityDate    DateTime @default(now())
  durationMinutes Int?
  
  // For calls
  callOutcome     String?  // connected, voicemail, no_answer, busy
  
  // For meetings
  meetingLocation String?
  attendees       String?  // Comma-separated names
  
  createdAt       DateTime @default(now())
  
  @@index([leadId])
  @@index([type])
  @@index([activityDate])
  @@map("crm_activities")
}

// Task - Follow-ups and to-dos for sales team
model Task {
  id              String   @id @default(uuid())
  
  title           String
  description     String?  @db.Text
  
  priority        TaskPriority @default(MEDIUM)
  status          TaskStatus @default(PENDING)
  
  dueDate         DateTime?
  completedAt     DateTime?
  
  // Related
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id])
  
  // Assignment
  assignedToId    String
  assignedTo      PlatformUser @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  createdById     String
  createdBy       PlatformUser @relation("CreatedTasks", fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([assignedToId])
  @@index([dueDate])
  @@map("crm_tasks")
}

// ==========================================
// SUBSCRIPTION PLANS
// ==========================================

model SubscriptionPlan {
  id              String   @id @default(uuid())
  name            String   // "Starter", "Professional"
  tier            SubscriptionTier
  description     String?
  
  // Pricing (ZMW is anchor currency)
  monthlyPriceZMW Decimal  @db.Decimal(10, 2)  // Base monthly price in ZMW
  yearlyPriceZMW  Decimal  @db.Decimal(10, 2)  // Yearly price in ZMW (discounted)
  monthlyPriceUSD Decimal  @db.Decimal(10, 2)  // USD equivalent
  yearlyPriceUSD  Decimal  @db.Decimal(10, 2)  // USD equivalent yearly
  
  // Per-student overage pricing
  pricePerStudentZMW Decimal @db.Decimal(10, 2) @default(20) // K20/student
  pricePerStudentUSD Decimal @db.Decimal(10, 2) @default(0.74) // ~$0.74/student
  
  // Included limits (students above this incur per-student charges)
  includedStudents Int      // Students included in base price
  maxStudents      Int      // Hard cap (0 = unlimited)
  maxTeachers      Int
  maxUsers         Int
  maxClasses       Int
  maxStorageGB     Int
  
  // SMS/Email limits per month
  includedSmsPerMonth   Int @default(0)
  includedEmailsPerMonth Int @default(100)
  
  // Features included (JSON array of feature keys)
  features        String[] // ["sms", "parent_portal", "api_access", "online_assessments"]
  
  isActive        Boolean  @default(true)
  isPopular       Boolean  @default(false)
  sortOrder       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  subscriptionPayments SubscriptionPayment[]
  
  @@map("subscription_plans")
}

// ==========================================
// SUBSCRIPTION PAYMENTS
// ==========================================

model SubscriptionPayment {
  id              String   @id @default(uuid())
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  planId          String
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  
  // Payment details
  baseAmount      Decimal  @db.Decimal(10, 2)  // Base plan price
  studentCount    Int      // Number of students at time of payment
  overageStudents Int      @default(0)         // Students above included limit
  overageAmount   Decimal  @db.Decimal(10, 2) @default(0) // Extra student charges
  totalAmount     Decimal  @db.Decimal(10, 2)  // Final amount charged
  currency        String   @default("ZMW")
  
  // Payment method & reference
  paymentMethod   String   // "mtn_momo", "airtel_money", "bank_transfer", "card"
  externalRef     String?  // Payment gateway reference
  receiptNumber   String?  @unique
  
  // Billing period
  billingCycle    BillingCycle @default(MONTHLY)
  periodStart     DateTime
  periodEnd       DateTime
  
  // Status
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  failureReason   String?
  
  // Metadata
  invoiceUrl      String?
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([status])
  @@map("subscription_payments")
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ==========================================
// CONTACT FORM SUBMISSIONS (from website)
// ==========================================

model ContactSubmission {
  id          String   @id @default(uuid())
  name        String
  email       String
  phone       String?
  schoolName  String?
  message     String
  isRead      Boolean  @default(false)
  notes       String?  // Internal notes from sales team
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("contact_submissions")
}

model User {
  id            String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email         String   
  passwordHash  String
  fullName      String
  role          Role
  profilePictureUrl String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  classesManaged Class[]
  paymentsRecorded Payment[]
  attendanceRecorded Attendance[]
  classMovementsRecorded ClassMovementLog[]
  children Student[] @relation("ParentChildren")
  assessmentsGraded AssessmentResult[]
  studentProfile Student?
  timetablePeriodsTaught TimetablePeriod[]
  lessonPlans    LessonPlan[]
  notifications  Notification[]
  
  // Chat Relations
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]
  pushSubscriptions        PushSubscription[]
  
  // Audit logs created by this user
  auditLogs                AuditLog[]

  // Email is unique within a tenant (same email can exist in different schools)
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, role])  // For filtering users by role
  @@index([tenantId, isActive])  // For filtering active users
  @@map("users")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  endpoint  String   @unique
  keys      Json     // Stores p256dh and auth keys
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

model Student {
  id              String        @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  admissionNumber String        
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  guardianName    String?
  guardianPhone   String?
  guardianEmail   String?
  address         String?
  status          StudentStatus @default(ACTIVE)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  classId         String
  class           Class         @relation(fields: [classId], references: [id])
  
  scholarshipId   String?
  scholarship     Scholarship?  @relation(fields: [scholarshipId], references: [id])

  payments        Payment[]
  attendance      Attendance[]
  feeStructures   StudentFeeStructure[]
  classMovements  ClassMovementLog[]
  
  parentId        String?
  parent          User?         @relation("ParentChildren", fields: [parentId], references: [id])
  
  userId          String?       @unique
  user            User?         @relation(fields: [userId], references: [id])

  assessmentResults AssessmentResult[]
  termResults       TermResult[]
  termReports       StudentTermReport[]
  submissions     AssessmentSubmission[]

  // Admission number unique per tenant
  @@unique([tenantId, admissionNumber])
  @@index([tenantId])
  @@index([tenantId, status])              // Filter active/inactive students
  @@index([tenantId, classId])             // Class roster queries
  @@index([tenantId, createdAt])           // Recent enrollments
  @@map("students")
}

model Class {
  id             String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name           String
  gradeLevel     Int
  teacherId      String
  teacher        User     @relation(fields: [teacherId], references: [id])
  academicTermId String
  academicTerm   AcademicTerm @relation(fields: [academicTermId], references: [id])
  
  students       Student[]
  attendance     Attendance[]
  subjects       Subject[] @relation("ClassSubjects")
  
  incomingMovements ClassMovementLog[] @relation("ToClass")
  outgoingMovements ClassMovementLog[] @relation("FromClass")
  
  assessments    Assessment[]
  termResults    TermResult[]
  termReports    StudentTermReport[]
  timetablePeriods TimetablePeriod[]
  topicProgress  TopicProgress[]
  lessonPlans    LessonPlan[]

  @@index([tenantId])
  @@map("classes")
}

model Subject {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String
  code      String   
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classes   Class[]  @relation("ClassSubjects")
  assessments Assessment[]
  termResults TermResult[]
  timetablePeriods TimetablePeriod[]
  topics          Topic[]
  lessonPlans     LessonPlan[]

  // Subject code unique per tenant
  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("subjects")
}

model AcademicTerm {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  classes      Class[]
  feeTemplates FeeTemplate[]
  assessments  Assessment[]
  termResults  TermResult[]
  studentReports StudentTermReport[]
  timetablePeriods TimetablePeriod[]
  lessonPlans    LessonPlan[]

  @@index([tenantId])
  @@map("academic_terms")
}

// NOTE: SchoolSettings is DEPRECATED - use Tenant model instead
// Keeping for backward compatibility during migration
model SchoolSettings {
  id                String   @id @default(uuid())
  schoolName        String   @default("My School")
  schoolAddress     String?
  schoolPhone       String?
  schoolEmail       String?
  schoolWebsite     String?
  logoUrl           String?
  
  // Theme Settings
  primaryColor      String   @default("#2563eb")
  secondaryColor    String   @default("#475569")
  accentColor       String   @default("#f59e0b")

  // System Configuration (DEPRECATED - use Tenant.currentTermId)
  currentTermId     String?  @unique

  updatedAt         DateTime @updatedAt

  @@map("school_settings")
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
}

model Notification {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      NotificationType @default(INFO)
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("notifications")
}

model FeeTemplate {
  id              String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name            String
  amount          Decimal  @db.Decimal(10, 2)
  academicTermId  String
  academicTerm    AcademicTerm @relation(fields: [academicTermId], references: [id])
  applicableGrade Int

  studentFeeStructures StudentFeeStructure[]

  @@index([tenantId])
  @@map("fee_templates")
}

model StudentFeeStructure {
  id            String   @id @default(uuid())
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id])
  feeTemplateId String
  feeTemplate   FeeTemplate @relation(fields: [feeTemplateId], references: [id])
  amountDue     Decimal  @db.Decimal(10, 2)
  amountPaid    Decimal  @db.Decimal(10, 2) @default(0)
  dueDate       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([studentId, feeTemplateId])
  @@map("student_fee_structures")
}

model Payment {
  id              String        @id @default(uuid())
  
  // Multi-tenant relation
  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  paymentDate     DateTime      @default(now())
  method          PaymentMethod
  transactionId   String?       @unique  // Auto-generated TXN-XXXXXXXX
  notes           String?                // Optional payment notes
  recordedByUserId String
  recordedBy      User          @relation(fields: [recordedByUserId], references: [id])
  createdAt       DateTime      @default(now())

  @@index([tenantId])
  @@index([tenantId, paymentDate])        // Financial reports
  @@index([tenantId, studentId])          // Student payment history
  @@index([tenantId, method, paymentDate]) // Payment method analytics
  @@index([transactionId])                // Transaction lookup
  @@map("payments")
}

model Attendance {
  id               String           @id @default(uuid())
  
  // Multi-tenant relation
  tenantId         String
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  studentId        String
  student          Student          @relation(fields: [studentId], references: [id])
  classId          String
  class            Class            @relation(fields: [classId], references: [id])
  date             DateTime
  status           AttendanceStatus
  reason           String?          // Reason for absence/lateness
  recordedByUserId String
  recordedBy       User             @relation(fields: [recordedByUserId], references: [id])

  @@index([tenantId])
  @@index([tenantId, date])                // Daily attendance
  @@index([tenantId, studentId, date])     // Student attendance history
  @@index([tenantId, classId, date])       // Class attendance reports
  @@map("attendance")
}

model ClassMovementLog {
  id              String   @id @default(uuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id])
  fromClassId     String?
  fromClass       Class?   @relation("FromClass", fields: [fromClassId], references: [id])
  toClassId       String
  toClass         Class    @relation("ToClass", fields: [toClassId], references: [id])
  reason          String?
  changedByUserId String?
  changedBy       User?    @relation(fields: [changedByUserId], references: [id])
  createdAt       DateTime @default(now())

  @@map("class_movement_logs")
}

model Assessment {
  id             String         @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title          String
  type           AssessmentType
  description    String?
  
  classId        String
  class          Class          @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject        @relation(fields: [subjectId], references: [id])
  termId         String
  term           AcademicTerm   @relation(fields: [termId], references: [id])
  
  totalMarks     Decimal        @db.Decimal(5, 2)
  weight         Decimal        @db.Decimal(5, 2) // Percentage weight (e.g., 30 for 30%)
  date           DateTime
  
  results        AssessmentResult[]
  
  isOnline       Boolean @default(false)
  durationMinutes Int?
  startTime      DateTime?
  endTime        DateTime?
  
  questions      Question[]
  submissions    AssessmentSubmission[]

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("assessments")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

model Question {
  id            String @id @default(uuid())
  assessmentId  String
  assessment    Assessment @relation(fields: [assessmentId], references: [id])
  text          String
  type          QuestionType
  points        Int
  options       QuestionOption[]
  correctAnswer String? // For auto-grading
  
  responses     StudentResponse[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("questions")
}

model QuestionOption {
  id         String @id @default(uuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  text       String
  isCorrect  Boolean @default(false)
  
  @@map("question_options")
}

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

model AssessmentSubmission {
  id           String @id @default(uuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  studentId    String
  student      Student @relation(fields: [studentId], references: [id])
  startedAt    DateTime @default(now())
  submittedAt  DateTime?
  score        Decimal?
  status       SubmissionStatus @default(IN_PROGRESS)
  
  responses    StudentResponse[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([assessmentId, studentId])
  @@map("assessment_submissions")
}

model StudentResponse {
  id           String @id @default(uuid())
  submissionId String
  submission   AssessmentSubmission @relation(fields: [submissionId], references: [id])
  questionId   String
  question     Question @relation(fields: [questionId], references: [id])
  answerText   String?
  selectedOptionId String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([submissionId, questionId])
  @@map("student_responses")
}

model AssessmentResult {
  id             String     @id @default(uuid())
  assessmentId   String
  assessment     Assessment @relation(fields: [assessmentId], references: [id])
  studentId      String
  student        Student    @relation(fields: [studentId], references: [id])
  
  score          Decimal    @db.Decimal(5, 2)
  remarks        String?
  
  gradedByUserId String
  gradedBy       User       @relation(fields: [gradedByUserId], references: [id])
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([assessmentId, studentId])
  @@map("assessment_results")
}

model TermResult {
  id             String       @id @default(uuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject      @relation(fields: [subjectId], references: [id])
  termId         String
  term           AcademicTerm @relation(fields: [termId], references: [id])
  
  totalScore     Decimal      @db.Decimal(5, 2)
  grade          String?
  remarks        String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([studentId, subjectId, termId])
  @@map("term_results")
}

model GradingScale {
  id        String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  grade     String   // "A"
  minScore  Int      // 80
  maxScore  Int      // 100
  remark    String?  // "Excellent"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("grading_scales")
}

model StudentTermReport {
  id             String       @id @default(uuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  termId         String
  term           AcademicTerm @relation(fields: [termId], references: [id])
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  
  totalAttendance Int?        // Days present
  totalDays       Int?        // Total school days
  
  classTeacherRemark String?
  principalRemark    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([studentId, termId])
  @@map("student_term_reports")
}

model TimetablePeriod {
  id             String       @id @default(uuid())
  
  // Multi-tenant relation
  tenantId       String
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  classId        String
  class          Class        @relation(fields: [classId], references: [id])
  subjectId      String
  subject        Subject      @relation(fields: [subjectId], references: [id])
  teacherId      String
  teacher        User         @relation(fields: [teacherId], references: [id])
  dayOfWeek      DayOfWeek
  startTime      String       // "08:00"
  endTime        String       // "08:40"
  academicTermId String
  academicTerm   AcademicTerm @relation(fields: [academicTermId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([tenantId])
  @@map("timetable_periods")
}

model Topic {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  gradeLevel  Int      // 1-12
  orderIndex  Int      @default(0)

  progress    TopicProgress[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("topics")
}

model TopicProgress {
  id          String   @id @default(uuid())
  topicId     String
  topic       Topic    @relation(fields: [topicId], references: [id])
  classId     String
  class       Class    @relation(fields: [classId], references: [id])
  status      TopicStatus @default(PENDING)
  completedAt DateTime?

  updatedAt   DateTime @updatedAt

  @@unique([topicId, classId])
  @@map("topic_progress")
}

model LessonPlan {
  id            String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  teacherId     String
  teacher       User     @relation(fields: [teacherId], references: [id])
  classId       String
  class         Class    @relation(fields: [classId], references: [id])
  subjectId     String
  subject       Subject  @relation(fields: [subjectId], references: [id])
  termId        String
  term          AcademicTerm @relation(fields: [termId], references: [id])
  
  weekStartDate DateTime
  title         String
  content       String   @db.Text
  fileUrl       String?  // For uploaded files

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@map("lesson_plans")
}

model Conversation {
  id        String    @id @default(uuid())
  
  // Multi-tenant relation
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  participants ConversationParticipant[]
  messages     Message[]

  @@index([tenantId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@map("messages")
}

model Scholarship {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  percentage  Decimal  @db.Decimal(5, 2) // 0-100
  description String?

  students    Student[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("scholarships")
}

// ==========================================
// AUDIT LOGGING - Track all important actions
// ==========================================

model AuditLog {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Who performed the action
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // What action was performed
  action      String   // CREATE, UPDATE, DELETE, LOGIN, PAYMENT, EXPORT, etc.
  entityType  String   // Student, Payment, User, etc.
  entityId    String?  // ID of the affected entity
  
  // Before/After values for tracking changes
  oldValue    Json?    // Previous state (for UPDATE/DELETE)
  newValue    Json?    // New state (for CREATE/UPDATE)
  
  // Additional metadata
  metadata    Json?    // Any extra context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId])
  @@index([tenantId, action])
  @@map("audit_logs")
}

// ==========================================
// USAGE METRICS - Track feature usage
// ==========================================

model UsageMetric {
  id          String   @id @default(uuid())
  
  // Multi-tenant relation
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // What metric is being tracked
  metricType  String   // SMS_SENT, EMAILS_SENT, API_CALLS, STORAGE_MB, REPORTS_GENERATED
  value       Int      @default(0)
  
  // Time period for aggregation
  periodStart DateTime @default(now())
  periodEnd   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId, metricType, periodStart])
  @@unique([tenantId, metricType, periodStart])
  @@map("usage_metrics")
}

