name: CI/CD Pipeline

on:
  push:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: lyangend/sync

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:master
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:buildcache,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:master
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure nginx directory exists on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p ~/app/nginx

      - name: Copy configuration files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "docker-compose.prod.yml,nginx-system.conf"
          target: "~/app"
          strip_components: 0

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/app
            
            # Create .env file with secure permissions
            cat > .env << 'EOF'
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NODE_ENV=production
            EOF
            chmod 600 .env
            
            # Login to GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images (force pull)
            docker-compose -f docker-compose.prod.yml pull --ignore-pull-failures
            
            # Stop and remove containers
            docker-compose -f docker-compose.prod.yml down --remove-orphans
            
            # Clean up any orphaned containers
            docker ps -a --filter "name=sync" --format "{{.ID}}" | xargs -r docker rm -f || true
            
            # Run migrations on host PostgreSQL
            echo "ğŸš€ Running database migrations..."
            docker-compose -f docker-compose.prod.yml run --rm backend npx prisma migrate deploy || {
              echo "âŒ Migration failed!"
              docker logs sync_backend --tail=50
              exit 1
            }
            
            # Start all services with latest images (force recreate)
            docker-compose -f docker-compose.prod.yml up -d --force-recreate --pull always
            
            # Wait for services to be healthy
            echo "â³ Waiting for services to be ready..."
            
            # Wait for backend
            for i in {1..30}; do
              if curl -s -f http://localhost:3002/api/health > /dev/null 2>&1; then
                echo "âœ… Backend is ready!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âš ï¸ Backend health check timeout (checking logs...)"
                docker logs sync_backend --tail=50
                exit 1
              fi
              sleep 3
            done
            
            # Wait for frontend
            for i in {1..20}; do
              if curl -s -f http://localhost:3003 > /dev/null 2>&1; then
                echo "âœ… Frontend is ready!"
                break
              fi
              if [ $i -eq 20 ]; then
                echo "âš ï¸ Frontend health check timeout (checking logs...)"
                docker logs sync_frontend --tail=50
                exit 1
              fi
              sleep 2
            done
            
            # Configure system nginx
            echo "ğŸ”§ Configuring system nginx..."
            
            # Remove old/duplicate sync configs
            sudo rm -f /etc/nginx/sites-enabled/sync-school || true
            
            # Only update nginx config if it has changed (preserves SSL config)
            if ! sudo diff -q ~/app/nginx-system.conf /etc/nginx/sites-available/sync-base 2>/dev/null; then
              echo "ğŸ“ Nginx config changed, updating..."
              # Backup the base config (without SSL)
              sudo cp ~/app/nginx-system.conf /etc/nginx/sites-available/sync-base
              
              # If SSL config exists, preserve it; otherwise use base
              if [ -f /etc/nginx/sites-available/sync ] && grep -q "ssl_certificate" /etc/nginx/sites-available/sync; then
                echo "âœ… SSL config detected, preserving..."
                # Keep the existing config with SSL
              else
                echo "ğŸ“‹ No SSL config, using base config..."
                sudo cp ~/app/nginx-system.conf /etc/nginx/sites-available/sync
              fi
              
              sudo ln -sf /etc/nginx/sites-available/sync /etc/nginx/sites-enabled/sync
              
              # Test nginx configuration
              sudo nginx -t || {
                echo "âŒ nginx configuration error"
                exit 1
              }
              
              # Reload nginx
              sudo systemctl reload nginx
            else
              echo "âœ… Nginx config unchanged, skipping update"
            fi
            
            # Show deployment status
            echo "ğŸ“Š Deployment Status:"
            docker-compose -f docker-compose.prod.yml ps
            
            # Test the application
            echo "ğŸ§ª Testing application..."
            if curl -s -f http://localhost/health > /dev/null 2>&1; then
              echo "âœ… Application is accessible via nginx!"
            else
              echo "âš ï¸ Application might not be accessible via nginx"
            fi
            
            # Clean up old Docker images to save space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            
            # Remove dangling images
            docker image prune -f
            
            # Remove old sync images (keep only latest 2)
            echo "Removing old sync/backend images..."
            docker images ghcr.io/lyangend/sync/backend --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +3 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "Removing old sync/frontend images..."
            docker images ghcr.io/lyangend/sync/frontend --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +3 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Show disk space saved
            echo "âœ… Cleanup complete"
            df -h / | tail -1
            
            # Create database backup (optional)
            echo "ğŸ’¾ Creating database backup..."
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} pg_dump -h localhost -U ${{ secrets.POSTGRES_USER }} ${{ secrets.POSTGRES_DB }} > "$BACKUP_FILE" 2>/dev/null && \
            echo "âœ… Backup created: $BACKUP_FILE" || \
            echo "âš ï¸ Backup skipped or failed"
            
            echo "ğŸ‰ Deployment completed successfully!"